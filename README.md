# Zabbix NUT Template

Данный шаблон позволяет мониторить ИБП, подключенные к серверам NUT. Обработка данных и сами запросы могут осуществляться на сервере Zabbix (через предустановленный агент), что минимизирует настройку и дальнейшее обслуживание. Можно мониторить ИБП, подключенные к любому серверу NUT.

Следующая инструкция подразумевает выполнение скрипта на агенте, расположенном на самом сервере Zabbix:

1. На серверах NUT разрешаем подключение клиентов с нужных интерфейсов (в файле `/etc/nut/upsd.conf` параметр `LISTEN`)
2. Устанавливаем на сервере Zabbix клиент для работы с NUT:
```
apt install -y nut-client
```
3. Для проверки получим сведения об ИБП, где `upsname` - имя ИБП на сервере NUT, `upshost` - IP или FQDN сервера NUT:
```
upsc upsname@upshost
```
Утилита должна получить и вывести данные ИБП. Если не выводит, проверьте настройки сервера NUT, а также попробуйте запустить эту команду локально на сервере NUT.

4. Файл `nut-ups.conf` помещаем в каталог пользовательских конфигураций: `/etc/zabbix/zabbix_agentd.d/nut-ups.conf`
5. Файл `nut-ups.sh` помещаем в предварительно созданный каталог скриптов агента: `/etc/zabbix/sh/nut-ups.sh`
6. Меняем владельцев и устанавливаем права на файлы, ограничивая право на выполнение только владельцем:
```
chown zabbix:zabbix /etc/zabbix/zabbix_agent2.d/nut-ups.conf
chown zabbix:zabbix /etc/zabbix/sh/nut-ups.sh
chmod 440 /etc/zabbix/zabbix_agent2.d/nut-ups.conf
chmod 500 /etc/zabbix/sh/nut-ups.sh
```
7. Перезапускаем Zabbix-агент
```
systemctl restart zabbix-agent
```
6. Импортируем шаблон. Правим его при необходимости, основываясь на информации, которая может быть получена командой `upsc` (мы ее использовали выше). Либо создаём клоны шаблона для разных моделей ИБП.
7. Создаем узел, добавляем ему интерфейс (тип - Агент, IP Адрес - 127.0.0.1), добавляем шаблон и прописываем макросы:

    `{$UPSHOST}` - IP или имя хоста NUT-сервера
   
    `{$UPSNAME}` - Имя ИБП, как оно задано на сервере NUT
   
9. Проверяем работу, дожидаясь получения данных от ИБП.

Ручная проверка работы скрипта (должен вернуть 1 при нормальной работе ИБП):
```
/etc/zabbix/sh/nut-ups.sh upsname upshost ups.status
```
